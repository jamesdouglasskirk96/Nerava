# Analytics & Product Metrics

## Overview

This document describes the analytics and product metrics system for Nerava, including data collection, processing, and KPI calculation.

## Architecture

### Data Flow
1. **Event Generation**: Domain events are generated by business operations
2. **Analytics Producer**: Converts domain events to analytics events
3. **Event Bus**: Distributes analytics events to subscribers
4. **Batch Writer**: Batches and persists analytics events to database
5. **KPI Calculator**: Calculates business metrics from stored events

### Components

#### Analytics Producer
- Converts domain events to analytics events
- Adds business context and properties
- Publishes to event bus

#### Batch Writer
- Batches analytics events for efficient database writes
- Configurable batch size and flush interval
- Error handling and retry logic

#### KPI Calculator
- Calculates business metrics from analytics data
- Supports multiple time periods
- Provides conversion funnels and utilization metrics

## Analytics Events

### Event Types

#### Charge Started Analytics
```json
{
  "event_type": "analytics_charge_started",
  "session_id": "session-123",
  "user_id": "user-456",
  "hub_id": "hub-789",
  "window_id": "green_hour",
  "properties": {
    "session_type": "charging",
    "has_active_window": true
  }
}
```

#### Charge Stopped Analytics
```json
{
  "event_type": "analytics_charge_stopped",
  "session_id": "session-123",
  "user_id": "user-456",
  "hub_id": "hub-789",
  "window_id": "green_hour",
  "kwh_consumed": 15.5,
  "total_reward_usd": 3.25,
  "properties": {
    "session_type": "charging",
    "has_active_window": true,
    "reward_tier": "medium"
  }
}
```

#### Wallet Credited Analytics
```json
{
  "event_type": "analytics_wallet_credited",
  "user_id": "user-456",
  "amount_cents": 325,
  "session_id": "session-123",
  "new_balance_cents": 1500,
  "properties": {
    "credit_type": "charging_reward",
    "amount_tier": "medium"
  }
}
```

## Key Performance Indicators

### Conversion Funnel
- **Sessions Started**: Total charging sessions initiated
- **Sessions Completed**: Sessions that were successfully stopped
- **Sessions Credited**: Sessions that resulted in wallet credits
- **Completion Rate**: Percentage of started sessions that were completed
- **Credit Rate**: Percentage of completed sessions that were credited

### Green Hour Utilization
- **Active Window Sessions**: Sessions during active incentive windows
- **Total Sessions**: All charging sessions
- **Utilization Rate**: Percentage of sessions during active windows
- **Average Reward**: Average reward per session

### Streak Metrics
- **Unique Users**: Number of unique users with charging activity
- **Total Sessions**: Total charging sessions
- **Sessions per User**: Average sessions per user
- **Average Reward**: Average reward per session

### Revenue Metrics
- **Total Rewards**: Total USD value of rewards distributed
- **Total Sessions**: Number of charging sessions
- **Average Reward**: Average reward per session

## API Endpoints

### Get All KPIs
```http
GET /v1/analytics/kpis?days=7
```

### Get Conversion Funnel
```http
GET /v1/analytics/kpis/conversion-funnel?days=7
```

### Get Green Hour Utilization
```http
GET /v1/analytics/kpis/green-hour-utilization?days=7
```

### Get Streak Metrics
```http
GET /v1/analytics/kpis/streak-metrics?days=30
```

### Get Revenue Metrics
```http
GET /v1/analytics/kpis/revenue-metrics?days=7
```

### Get Analytics Stats
```http
GET /v1/analytics/stats
```

### Get Analytics Health
```http
GET /v1/analytics/health
```

## Database Schema

### analytics_events Table
```sql
CREATE TABLE analytics_events (
    id SERIAL PRIMARY KEY,
    event_id VARCHAR(100) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    region VARCHAR(50) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    properties TEXT,
    created_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_analytics_events_type ON analytics_events(event_type);
CREATE INDEX idx_analytics_events_timestamp ON analytics_events(timestamp);
CREATE INDEX idx_analytics_events_region ON analytics_events(region);
CREATE INDEX idx_analytics_events_aggregate ON analytics_events(aggregate_id);
```

## Configuration

### Environment Variables
- `ANALYTICS_BATCH_SIZE`: Batch size for analytics writes (default: 100)
- `ANALYTICS_FLUSH_INTERVAL`: Flush interval in seconds (default: 30)
- `ANALYTICS_ENABLED`: Enable analytics collection (default: true)

### Batch Writer Settings
```python
analytics_batch_writer = AnalyticsBatchWriter(
    batch_size=100,
    flush_interval=30
)
```

## Monitoring

### Metrics to Track
- **Event Volume**: Number of analytics events per minute
- **Batch Write Latency**: Time to write batches to database
- **Error Rate**: Percentage of failed event writes
- **Queue Depth**: Number of events waiting to be written

### Alerts
- High error rate in analytics batch writer
- Analytics events not being written
- KPI calculation failures
- Database connection issues

## Data Retention

### Retention Policy
- **Raw Events**: 90 days
- **Aggregated Metrics**: 2 years
- **KPI Data**: 5 years

### Cleanup Process
```sql
-- Delete events older than 90 days
DELETE FROM analytics_events 
WHERE created_at < NOW() - INTERVAL '90 days';
```

## Future Enhancements

### Real-time Analytics
- Stream processing with Apache Kafka
- Real-time dashboards with Grafana
- Alerting on KPI thresholds

### Advanced Analytics
- Machine learning for user behavior
- Predictive modeling for charging patterns
- A/B testing framework

### Data Export
- Export to data warehouse (BigQuery, Snowflake)
- ETL pipelines for business intelligence
- API for external analytics tools

## Troubleshooting

### Common Issues

#### Analytics Events Not Being Written
1. Check batch writer status: `GET /v1/analytics/health`
2. Verify database connectivity
3. Check for errors in logs
4. Ensure event bus is working

#### KPI Calculation Errors
1. Check database query performance
2. Verify data quality in analytics_events table
3. Check for missing indexes
4. Review query timeouts

#### High Memory Usage
1. Check batch writer queue size
2. Monitor L1 cache memory usage
3. Review event volume
4. Check for memory leaks

### Debug Commands
```bash
# Check analytics health
curl http://localhost:8000/v1/analytics/health

# Get analytics stats
curl http://localhost:8000/v1/analytics/stats

# Get KPIs for last 7 days
curl http://localhost:8000/v1/analytics/kpis?days=7
```

## Performance Optimization

### Database Optimization
- Use appropriate indexes
- Partition by date for large tables
- Regular VACUUM and ANALYZE
- Monitor query performance

### Caching Strategy
- Cache frequently accessed KPIs
- Use Redis for real-time metrics
- Implement cache warming
- Monitor cache hit rates

### Batch Processing
- Optimize batch sizes
- Use connection pooling
- Implement retry logic
- Monitor write latency
