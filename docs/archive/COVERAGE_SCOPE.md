# Coverage Scope Documentation

**Last Updated:** 2025-01-XX  
**Coverage Target:** 55%  
**Coverage Tool:** pytest-cov / coverage.py

## What is Included

Coverage measurement includes **only production backend code** that is shipped and executed in production:

- **`app/**`** - All application code in the `app/` directory
  - Routers (`app/routers/`)
  - Services (`app/services/`)
  - Models (`app/models/`)
  - Middleware (`app/middleware/`)
  - Core utilities (`app/core/`)
  - Integrations (`app/integrations/`)
  - All other production modules

## What is Excluded

The following are explicitly excluded from coverage measurement:

### 1. Test Files
- **`*/tests/*`** - All test directories
- **`*/test_*.py`** - Test files (any file starting with `test_`)

**Rationale:** Test files are not production code and should not count toward coverage metrics.

### 2. Database Migrations
- **`*/migrations/*`** - Alembic migration files

**Rationale:** Migrations are version-controlled database schema changes, not application logic. They are tested separately via migration rollback/forward tests.

### 3. Compiled Python
- **`*/__pycache__/*`** - Python bytecode cache directories

**Rationale:** Compiled bytecode is generated, not source code.

### 4. Legacy Code
- **`app/legacy/**`** - Legacy code directory

**Rationale:** Legacy code is documented as non-production and kept for reference only. It is not executed in production deployments.

### 5. Legacy Server Code
- **`server/**`** - Legacy server directory

**Rationale:** This is legacy code that is not used in production. The production entrypoint is `app/main_simple.py`, not `server/`.

## Coverage Configuration

Coverage is configured in two places (must be kept in sync):

1. **`pytest.ini`** - Primary configuration for pytest-cov
   - `[coverage:run]` section defines source and omit patterns
   - `[coverage:report]` section defines reporting thresholds

2. **`scripts/prod_gate.sh`** - Production quality gate script
   - Uses same threshold (55%) as pytest.ini
   - Runs `pytest --cov=app --cov-fail-under=55`

## Rules for Adding New Excludes

When adding new excludes, follow these rules:

1. **Justification Required:** Every exclude must have a documented reason
2. **Non-Production Only:** Only exclude code that is definitively not executed in production
3. **Update Both Configs:** Update both `pytest.ini` and this document
4. **Document Here:** Add the exclude to this document with rationale

### Example: Adding a New Exclude

If you need to exclude a new directory (e.g., `app/generated/`):

1. Add to `pytest.ini`:
   ```ini
   [coverage:run]
   omit = 
       ...
       app/generated/**
   ```

2. Add to this document:
   ```markdown
   ### 6. Generated Code
   - **`app/generated/**`** - Auto-generated code
   
   **Rationale:** This code is generated by build tools and not manually maintained.
   ```

## Current Coverage Status

- **Current:** 45%
- **Target:** 55%
- **Gap:** 10 percentage points

See `docs/BASELINE_COVERAGE_REPORT.md` for detailed breakdown of uncovered files.

## Verification

To verify coverage scope is correct:

```bash
cd nerava-backend-v9
source .venv/bin/activate
pytest --cov=app --cov-report=term-missing
```

The coverage report should:
- ✅ Include all `app/` production code
- ✅ Exclude all test files
- ✅ Exclude migrations
- ✅ Exclude legacy code
- ✅ Show accurate percentage of production code coverage










