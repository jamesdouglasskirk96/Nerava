<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nerava</title>

  <link rel="stylesheet" href="css/tokens.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preload" as="image" href="./img/brands/starbucks.png" imagesizes="64px" />
    <link rel="stylesheet" href="css/animations.css" />
    <link rel="stylesheet" href="css/appleish.css" />
    <link rel="stylesheet" href="css/demo.css" />
    <link rel="stylesheet" href="css/modal.css" />
    <style>
      /* Pages sit above fixed tabbar and can scroll */
      .page{
        height: calc(100vh - var(--tabbar-height));
        overflow-y: auto; -webkit-overflow-scrolling: touch;
        padding: var(--content-pad);
      }
      /* Map box: reasonable height across phones */
      .map-wrap{
        position: relative;
        height: clamp(260px, 45vh, 420px);
        margin: 8px 8px 16px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0,0,0,.10);
        background: #f6f7f9;
      }
      #map{ height:100%; width:100%; }
      .leaflet-control-attribution{ margin-bottom: calc(var(--safe-bottom) + 8px) !important; }

      /* AI badge (kept from earlier) */
      .ai-badge{
        display:inline-flex;align-items:center;gap:4px;
        background: var(--brand); color:#fff;
        padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;
        box-shadow:0 6px 18px color-mix(in srgb, var(--brand) 25%, transparent);
        white-space:nowrap;
      }

      /* Recommendation/hero visual constraints */
      .recommend-card{ border-radius:16px; background:#fff; padding:12px; box-shadow:0 6px 22px rgba(0,0,0,.06); margin: 8px; }
      .perk-hero{ max-height:160px; overflow:hidden; border-radius:16px; margin: 8px auto 0; }
      .perk-hero img, .perk-hero svg{ max-height:160px; width:auto; max-width:100%; display:block; margin:0 auto; }
    </style>
  <link rel="icon" href="assets/favicon.ico" />

  <!-- Leaflet core -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- Routing plugin (after Leaflet) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>
<body>
  <div id="app" class="app-root">
    <header class="topbar">
      <h1 class="brand-logo" aria-label="Nerava">NERAVA <span class="bolt">âš¡</span></h1>
    </header>

    <!-- Map is now contained within the Explore page card -->

        <!-- Explore page -->
        <section id="page-explore" class="page active" aria-label="Explore">
          <div class="map-card">
            <div id="map" class="leaflet-map"></div>
          </div>

          <section id="perkSection" class="section">
            <h2 class="h2">Nearby perk</h2>

            <!-- left-aligned badge under heading -->
            <div id="perk-badge-row">
              <span id="perk-badge" class="perk-badge">
                <span class="bolt" aria-hidden="true">âš¡</span>
                <span>Recommended by Nerava AI</span>
              </span>
            </div>

            <!-- Perk card -->
            <article id="perkCard" class="perk-card">
              <div class="perk-card__body">
                <div class="perk-card__text">
                  <h3 id="perk-title" class="perk-title">Starbucks</h3>
                  <p id="perk-address" class="perk-address">310 E 5th St, Austin, TX</p>
                  <p id="perk-sub" class="perk-sub">Free coffee 2â€“4pm â€¢ 3 min walk</p>
                </div>
                <div class="perk-card__media">
                  <img id="perk-logo" class="perk-logo" src="./img/brands/starbucks.png" alt="Starbucks" />
                </div>
              </div>

              <button id="perk-cta" class="btn btn-wide" type="button">Charge here</button>
            </article>

            <!-- View more -->
            <button id="view-more" class="btn btn-wide btn-ghost" type="button">
              View more perks
            </button>
          </section>

          <!-- Spacer to ensure View more button is above tab bar -->
          <div style="height: calc(var(--tabbar-height, 88px) + env(safe-area-inset-bottom, 16px));"></div>
        </section>

      <!-- Charge / Wallet / Profile now padded pages (not overlay sheets) -->
      <section id="page-charge" class="page">
        <!-- Map for route to charger -->
        <div id="chargeMap" class="map app-map" role="application" aria-label="Map"></div>
        
        
        <!-- Floating perk recommendation over map -->
        <div class="floating-perk-card">
          <div class="perk-card">
            <div class="perk-card__left">
              <img src="/app/img/coffee.svg" alt="" class="perk-icon">
              <div class="perk-meta">
                <div class="perk-title">Coffee & Pastry</div>
                <div class="perk-sub">Free coffee and pastry with charging.</div>
              </div>
            </div>
            <button class="btn btn-primary">View more</button>
          </div>
          <div class="perk-stats">
            <span>~83 min</span>
            <span>â€¢</span>
            <span>70.6 mi</span>
          </div>
        </div>
        
        <div id="chargePane" class="pane" style="display:none;">
          <div class="card" id="chargeStatusCard" style="margin:12px;">
            <h3>Charging activity</h3>

            <!-- Cumulative kWh total -->
            <div id="cumulativeKwh" style="margin:8px 0; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb;">
              <div><strong>Total charged:</strong> <span id="totalKwh">0.0</span> kWh</div>
            </div>

            <!-- Live window / reward preview -->
            <div id="rewardPreview" style="display:none; margin:8px 0; padding:10px; border-radius:12px; background:#0B2A4A; color:#fff;">
              <div id="rewardPreviewText" style="font-weight:600;"></div>
              <div id="rewardPreviewSub" style="opacity:0.85; font-size:0.9em;"></div>
            </div>

            <!-- Active session status -->
            <div id="activeSession" style="display:none; margin:8px 0; padding:10px; border:1px solid #e5e7eb; border-radius:12px;">
              <div><strong>Session:</strong> <span id="sessionIdShort"></span></div>
              <div><strong>Started:</strong> <span id="sessionStart"></span></div>
              <div><strong>Elapsed:</strong> <span id="sessionElapsed"></span></div>
            </div>

            <!-- Controls -->
            <div id="chargeControls" style="margin-top:10px; display:flex; gap:8px;">
              <button id="btnStartCharge" class="btn btn-primary" style="flex:1;">Start charging</button>
              <button id="btnStopCharge" class="btn btn-secondary" style="flex:1;" disabled>Stop & credit</button>
            </div>

            <!-- kWh prompt (shown on stop) -->
            <dialog id="kwhDialog" style="z-index:3000;">
              <form method="dialog" style="min-width:260px;">
                <h4>How many kWh did you add?</h4>
                <input id="kwhInput" type="number" min="0.1" step="0.1" placeholder="e.g. 18.6" required style="width:100%; padding:8px; margin:8px 0;">
                <menu style="display:flex; gap:8px; justify-content:flex-end;">
                  <button data-return="cancel">Cancel</button>
                  <button data-return="confirm">Confirm</button>
                </menu>
              </form>
            </dialog>
          </div>


          <!-- Community Activity (Venmo-style) -->
          <section id="communityActivity" class="card" style="margin:12px;">
            <div class="card-header">
              <h3>Community Activity</h3>
              <div class="seg">
                <button id="feedAllBtn" class="seg-btn active">All</button>
                <button id="feedFollowingBtn" class="seg-btn">Following</button>
              </div>
            </div>
            <ul id="activityFeed" class="feed-list">
              <!-- items injected -->
            </ul>
          </section>

          <!-- Leaderboard -->
          <section id="leaderboard" class="card" style="margin:12px;">
            <h3>Weekly Leaders</h3>
            <div id="leaderboardList" class="leaderboard-list">
              <!-- items injected -->
            </div>
          </section>
        </div>
      </section>

      <section id="page-wallet" class="page page-padded">
        <section class="card content-card">
          <h2 class="section-title">Wallet</h2>
          <div class="balance" id="wallet-balance">$19.00</div>
          <div class="muted">Ways you earned</div>
          
          <!-- Progress bar toward next tier -->
          <div class="wallet-progress" style="margin:8px 0 12px;">
            <div class="bar" style="width:0"></div>
            <div class="progress-text">$6 more to reach Gold tier</div>
          </div>
          
          <!-- Streak indicator -->
          <div class="streak-indicator" style="margin: 8px 0; padding: 8px; background: var(--color-orange); border-radius: var(--radius); text-align: center;">
            <span class="streak-text">7-day charging streak ðŸ”¥</span>
          </div>

          <!-- Quick Actions -->
          <div class="wallet-actions" style="margin: 16px 0; display: flex; gap: 8px;">
            <button class="btn btn-secondary" style="flex: 1;">Add Funds</button>
            <button id="withdrawBtn" class="btn btn-secondary" style="flex: 1;">Withdraw</button>
          </div>
          
          <!-- Payout History -->
          <div class="payout-history" style="margin: 16px 0;">
            <h3 style="margin: 0 0 8px 0; font-size: 16px;">Recent Withdrawals</h3>
            <div id="payoutHistory" class="payout-list">
              <!-- Payout history will be loaded here -->
            </div>
          </div>
          
          <ul class="list" id="wallet-activity">
            <li><span>You saved $3.73 during Green Hour ðŸŒž</span><strong>+$3.73</strong></li>
            <li><span>Earned $0.75 from Starbucks co-fund â˜•</span><strong>+$0.75</strong></li>
            <li><span>Off-peak award</span><strong>+$0.50</strong></li>
          </ul>
        </section>
      </section>

      <section id="page-claim" class="page page-padded">
        <div class="card">
          <h3>Claim Rewards</h3>
          <div id="claimMap" style="height: 200px; background: #f0f0f0; border-radius: 12px; margin: 12px 0;"></div>
          <div id="claimStatus" class="claim-status">Move closer to the charger to claim rewards</div>
          <div id="incentivesList" class="incentives-list">
            <!-- Dynamic incentives will be populated here -->
          </div>
        </div>
      </section>

      <section id="page-profile" class="page hidden" aria-labelledby="meHeading">
        <div class="sheet">
          <header class="sheet__header">
            <h2 id="meHeading">Your profile</h2>
          </header>
          <div class="sheet__body">
            <div class="card profile-card">
              <img class="avatar" src="/app/img/avatar-demo.svg" alt="Profile photo"/>
              <div class="profile-meta">
                <div class="name">@you</div>
                <div class="rep">Green Reputation: <strong id="repScore">â€”</strong></div>
                <div class="follows">
                  <span id="followersCount">0</span> followers Â·
                  <span id="followingCount">0</span> following
                </div>
              </div>
              <button id="editPrefsBtn" class="btn-secondary">Preferences</button>
            </div>

            <div class="card">
              <h3>Vehicle</h3>
              <div id="vehicleInfo">Add your EV for smarter suggestions</div>
              <button id="editCarBtn" class="btn">Add vehicle</button>
            </div>

            <div class="card">
              <h3>Notifications</h3>
              <label class="switch">
                <input id="greenHourNotif" type="checkbox" />
                <span>Green Hour alerts</span>
              </label>
              <label class="switch">
                <input id="perkNotif" type="checkbox" />
                <span>Nearby perk alerts</span>
              </label>
            </div>

            <div class="card">
              <h3>Account</h3>
              <button id="logoutBtn" class="btn-danger">Sign out</button>
            </div>
          </div>
        </div>
      </section>

      <section id="pageDev" class="page hidden" aria-labelledby="devHeading">
        <div class="sheet">
          <header class="sheet__header">
            <h2 id="devHeading">Developer Tools</h2>
          </header>
          <div class="sheet__body" id="dev-content">
            <!-- Dev content will be loaded here -->
          </div>
        </div>
      </section>

  </div>

  <!-- Account Sheet (Venmo-style): full-screen modal with wallet & activity -->
  <dialog id="accountSheet" class="account-sheet" aria-label="Account">
    <div class="sheet">
      <div class="grip" role="presentation"></div>
      <section class="acct-hero">
        <img class="avatar" src="/app/img/avatar-demo.svg" alt="User avatar"/>
        <div class="who">
          <h2>James Kirk</h2>
          <p class="sub">demo@nerava.app</p>
        </div>
        <button class="pill small" id="btnManage">Manage</button>
      </section>

      <section class="wallet-card">
        <div class="left">
          <div class="label">Wallet balance</div>
          <div class="amount" id="acctBalance">$0.00</div>
          <div class="tier"><span id="acctTierProgress" style="width:0%"></span></div>
          <div class="streak" id="acctStreak">0-day charging streak ðŸ”¥</div>
        </div>
        <div class="right">
          <button id="btnAddFunds" class="btn solid">Add / withdraw</button>
        </div>
      </section>

      <section class="activity">
        <h3>Recent Activity</h3>
        <ul id="acctActivity" class="feed"></ul>
      </section>

      <section class="social">
        <h3>Following</h3>
        <div id="acctFollowing" class="following"></div>
      </section>

      <section class="settings">
        <h3>Settings</h3>
        <ul class="list">
          <li><button class="row">Notifications</button></li>
          <li><button class="row">Privacy</button></li>
          <li><button class="row">Sign out</button></li>
        </ul>
      </section>
    </div>
  </dialog>

  <nav class="tabbar">
    <a class="tab" data-tab="explore"><span class="icon">
      <!-- pin -->
      <svg viewBox="0 0 24 24"><path d="M12 21s-7-7.2-7-11a7 7 0 0 1 14 0c0 3.8-7 11-7 11Z"/><circle cx="12" cy="10" r="2.5"/></svg>
    </span><span class="label">Explore</span></a>

    <a class="tab" data-tab="charge"><span class="icon">
      <!-- battery -->
      <svg viewBox="0 0 24 24"><rect x="3" y="7" width="16" height="10" rx="2"/><rect x="19" y="10" width="2" height="4" rx="1"/></svg>
    </span><span class="label">Charge</span></a>

    <a class="tab" data-tab="earn" aria-hidden="true" style="pointer-events:none; opacity:0;"></a>

    <a class="tab" data-tab="wallet"><span class="icon">
      <!-- card -->
      <svg viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 10h18"/></svg>
    </span><span class="label">Wallet</span></a>

    <a class="tab" data-tab="profile"><span class="icon">
      <!-- user -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 19a8 8 0 0 1 16 0"/></svg>
    </span><span class="label">Me</span></a>
  </nav>

  <!-- Center Earn FAB -->
  <button id="fab-earn" aria-label="Earn">
    <div class="fab-content">
      <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span>
      <span class="label">Earn</span>
    </div>
  </button>


  <!-- Main app -->
  <script type="module" src="/app/js/app.js" defer></script>
  
</body>
</html>

