(() => {
  function ready(fn){ document.readyState!=='loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  const $ = (id)=>document.getElementById(id);
  const click = (id,fn)=>{ const el=$(id); if(el) el.addEventListener('click',fn,{passive:true}); };

  function initMap(){
    const mapEl = $('map');
    if(!mapEl){ console.warn('[Nerava] #map missing'); return; }
    if(typeof L==='undefined'){ setTimeout(initMap,100); return; }
    if(mapEl.dataset.ready==='1') return;

    const map = L.map('map',{ zoomControl:false });
    map.setView([30.4017, -97.7239], 14); // Domain, Austin
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

    mapEl.dataset.ready='1';
    window._map = map;
  }

  function wireNav(){
    const banner = $('dealBanner');
    const setTab = (name)=>{
      ['Explore','Charge','Wallet','Profile'].forEach(t=>{
        const b=$('tab'+t); if(b) b.classList.toggle('active',t===name);
      });
      if(banner) banner.style.display = (name==='Explore') ? '' : 'none';
    };
    click('tabExplore',()=>setTab('Explore'));
    click('tabCharge', ()=>setTab('Charge'));
    click('tabWallet', ()=>setTab('Wallet'));
    click('tabProfile',()=>setTab('Profile'));

    click('navigateBtn', ()=>{
      const q = encodeURIComponent('Nerava Hub, Domain Austin');
      const url = /iPhone|iPad|Macintosh/.test(navigator.userAgent)
        ? `http://maps.apple.com/?q=${q}`
        : `https://maps.google.com/?q=${q}`;
      window.open(url,'_blank');
    });
  }

  ready(()=>{
    wireNav();
    setTimeout(initMap,0);
    setTimeout(initMap,300);
  });
})();
