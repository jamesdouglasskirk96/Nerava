(() => {
  function onReady(fn){ document.readyState !== 'loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  function qs(id){ return document.getElementById(id); }
  function safeClick(id, handler){ const el = qs(id); if (el) el.addEventListener('click', handler, {passive:true}); }

  function initMap() {
    const mapEl = qs('map');
    if (!mapEl) { console.warn('[Nerava] #map not found; skipping map init'); return; }
    if (typeof L === 'undefined') {
      console.warn('[Nerava] Leaflet L not ready yet; retryingâ€¦');
      setTimeout(initMap, 120);
      return;
    }
    if (mapEl.dataset.ready === '1') return; // idempotent

    const map = L.map('map', { zoomControl: false });
    map.setView([30.4017, -97.7239], 14); // Domain, Austin

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    mapEl.dataset.ready = '1';
    window._neravaMap = map;
  }

  function wireUI(){
    // Show banner only on Explore
    const banner = qs('dealBanner');
    const setTab = (name) => {
      ['Explore','Charge','Wallet','Profile'].forEach(t => {
        const btn = qs('tab' + t);
        if (btn) btn.classList.toggle('active', t === name);
      });
      if (banner) banner.style.display = (name === 'Explore') ? '' : 'none';
    };

    safeClick('tabExplore', () => setTab('Explore'));
    safeClick('tabCharge',  () => setTab('Charge'));
    safeClick('tabWallet',  () => setTab('Wallet'));
    safeClick('tabProfile', () => setTab('Profile'));

    // Navigate action (for now, just open Apple/Google maps search to the hub)
    safeClick('navigateBtn', () => {
      const q = encodeURIComponent('Nerava Hub, Domain Austin');
      const url = /iPhone|iPad|Macintosh/.test(navigator.userAgent)
        ? `http://maps.apple.com/?q=${q}`
        : `https://maps.google.com/?q=${q}`;
      window.open(url, '_blank');
    });

    // Render the seeded card values (kept simple & static for now)
    const hubName = document.querySelector('.hub-name');
    if (hubName) hubName.textContent = 'Nerava Hub';
    const subtitle = document.querySelector('.hub-subtitle');
    if (subtitle) subtitle.textContent = 'Recommended';
  }

  onReady(() => {
    wireUI();
    // Map after a tick so Leaflet (defer) is loaded
    setTimeout(initMap, 0);
    // and a small retry in case device is slow to load CDN
    setTimeout(initMap, 300);
  });
})();
