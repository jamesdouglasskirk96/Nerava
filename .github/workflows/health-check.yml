name: Production Health Check

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check all endpoints
        id: endpoints
        run: |
          FAILED=""
          RESULTS=""

          check_url() {
            local name="$1" url="$2" expected_status="${3:-200}"
            local start end duration status

            start=$(date +%s%N)
            status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$url") || status="000"
            end=$(date +%s%N)
            duration=$(( (end - start) / 1000000 ))

            if [[ "$status" == "$expected_status" && "$duration" -lt 15000 ]]; then
              RESULTS="${RESULTS}  ${name} ... OK (${status}, ${duration}ms)\n"
            else
              RESULTS="${RESULTS}  ${name} ... FAIL (${status}, ${duration}ms)\n"
              FAILED="${FAILED}${name} "
            fi
          }

          check_url "API Health"    "https://api.nerava.network/healthz"
          check_url "Driver App"    "https://app.nerava.network"
          check_url "Merchant App"  "https://merchant.nerava.network"
          check_url "Admin App"     "https://admin.nerava.network"
          check_url "Landing Page"  "https://nerava.network"

          echo -e "\n=== Endpoint Check Results ===\n"
          echo -e "$RESULTS"

          if [[ -n "$FAILED" ]]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
            echo "failed_services=$FAILED" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

          # Store results for issue body
          {
            echo 'results<<EOF'
            echo -e "$RESULTS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Set up Python
        if: steps.endpoints.outputs.failed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Run integration health check
        if: steps.endpoints.outputs.failed == 'true'
        id: integration-check
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        working-directory: backend
        run: |
          pip install -q boto3 requests
          pip install -q -r requirements.txt
          python scripts/prod_api_health_check.py --prod 2>&1 | tee /tmp/health_output.txt

      - name: Create GitHub issue on failure
        if: steps.endpoints.outputs.failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failed = '${{ steps.endpoints.outputs.failed_services }}'.trim();
            const results = `${{ steps.endpoints.outputs.results }}`;
            const now = new Date().toISOString();

            // Check for existing open alert issues to avoid duplicates
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'alert,production',
              state: 'open',
              per_page: 5,
            });

            // Don't create duplicate if there's an open alert from the last hour
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            const recentAlert = existing.data.find(
              i => new Date(i.created_at) > oneHourAgo
            );
            if (recentAlert) {
              console.log(`Skipping: recent alert #${recentAlert.number} already open`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Alert: ${failed.trim()} unhealthy`,
              body: [
                `## Production Health Check Failed`,
                `**Time:** ${now}`,
                `**Failed services:** ${failed}`,
                ``,
                `### Endpoint Results`,
                '```',
                results,
                '```',
                ``,
                `### Actions`,
                `- [ ] Investigate root cause`,
                `- [ ] Check [App Runner logs](https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups/log-group/$252Faws$252Fapprunner$252Fnerava-backend)`,
                `- [ ] Check [RDS metrics](https://console.aws.amazon.com/rds/home?region=us-east-1)`,
                `- [ ] Verify fix and close this issue`,
                ``,
                `*Auto-generated by [health-check workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`,
              ].join('\n'),
              labels: ['alert', 'production'],
            });
