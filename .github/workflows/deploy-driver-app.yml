name: Deploy - Driver App

on:
  push:
    branches:
      - main
    paths:
      - 'apps/driver/**'
      - '.github/workflows/deploy-driver-app.yml'

defaults:
  run:
    working-directory: apps/driver

jobs:
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci-driver-app.yml

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: ci
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/driver/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Option 1: OIDC (recommended) - uncomment these lines and comment out Option 2
          # role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # aws-region: us-east-1
          # Option 2: Static keys (fallback) - comment out if using OIDC
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy assets to S3 with long cache
        run: |
          aws s3 sync dist/assets/ s3://${{ secrets.AWS_S3_BUCKET_DRIVER }}/assets/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html"

      - name: Deploy index.html with no-cache
        run: |
          aws s3 cp dist/index.html s3://${{ secrets.AWS_S3_BUCKET_DRIVER }}/index.html \
            --cache-control "no-cache"

      - name: Deploy other static files
        run: |
          # Deploy any other files in dist/ root (e.g., favicon, robots.txt)
          for file in dist/*.{ico,png,svg,txt,xml} 2>/dev/null; do
            if [ -f "$file" ]; then
              aws s3 cp "$file" s3://${{ secrets.AWS_S3_BUCKET_DRIVER }}/ \
                --cache-control "public,max-age=3600"
            fi
          done

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_DRIVER }} \
            --paths "/index.html" "/assets/*"

      - name: Verify deployment
        run: |
          CLOUDFRONT_URL="https://$(aws cloudfront get-distribution --id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID_DRIVER }} --query 'Distribution.DomainName' --output text)"
          echo "CloudFront URL: $CLOUDFRONT_URL"
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CLOUDFRONT_URL/index.html" || echo "000")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Warning: index.html returned HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Deployment verified successfully"
